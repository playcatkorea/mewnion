name: Supabase Keep Alive

# Supabase ë¬´ë£Œ í”Œëœì€ 7ì¼ ë¹„í™œì„±ì‹œ ìë™ ì¤‘ì§€ë˜ë¯€ë¡œ
# ë§¤ì¼ ì‹¤í–‰í•˜ì—¬ í”„ë¡œì íŠ¸ë¥¼ í™œì„± ìƒíƒœë¡œ ìœ ì§€í•©ë‹ˆë‹¤
on:
  schedule:
    # ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 9ì‹œ (UTC 0ì‹œ)
    - cron: '0 0 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  keep-supabase-active:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ping Supabase REST API
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Supabase Keep-Alive Script Started"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“… Date: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ”§ Project: mewnion"
          echo ""

          # 1. Health Check
          echo "1ï¸âƒ£ Checking Supabase health endpoint..."
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://ylyypseqjlwsfakagbpn.supabase.co/rest/v1/" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            --max-time 30) || HEALTH_STATUS="FAILED"

          if [ "$HEALTH_STATUS" = "200" ]; then
            echo "   âœ… Health check passed (HTTP $HEALTH_STATUS)"
          else
            echo "   âš ï¸ Health check returned: $HEALTH_STATUS"
            echo "   â„¹ï¸ This might indicate the project is paused"
          fi
          echo ""

          # 2. Database Connection Test (ê°„ë‹¨í•œ ì¿¼ë¦¬)
          echo "2ï¸âƒ£ Testing database connection..."
          DB_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://ylyypseqjlwsfakagbpn.supabase.co/rest/v1/profiles?select=count" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            --max-time 30) || DB_STATUS="FAILED"

          if [ "$DB_STATUS" = "200" ] || [ "$DB_STATUS" = "206" ]; then
            echo "   âœ… Database connection successful (HTTP $DB_STATUS)"
          else
            echo "   âš ï¸ Database query returned: $DB_STATUS"
          fi
          echo ""

          # 3. Summary
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Summary:"
          echo "   â€¢ Health API: $HEALTH_STATUS"
          echo "   â€¢ Database: $DB_STATUS"

          if [ "$HEALTH_STATUS" = "200" ] && { [ "$DB_STATUS" = "200" ] || [ "$DB_STATUS" = "206" ]; }; then
            echo "   â€¢ Status: âœ… Project is ACTIVE"
          else
            echo "   â€¢ Status: âš ï¸ Project might be PAUSED"
            echo ""
            echo "â„¹ï¸ If project is paused:"
            echo "   1. Go to https://supabase.com/dashboard"
            echo "   2. Find 'mewnion' project"
            echo "   3. Click 'Resume project' button"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Create activity log
        run: |
          mkdir -p logs
          echo "$(date '+%Y-%m-%d %H:%M:%S') - Keep-alive ping executed" >> logs/activity.log
          tail -n 30 logs/activity.log > logs/activity.tmp
          mv logs/activity.tmp logs/activity.log

      - name: Commit activity log (optional)
        continue-on-error: true
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add logs/activity.log || true
          git commit -m "chore: update keep-alive log [skip ci]" || echo "No changes to commit"
          # git push ëŠ” ì£¼ì„ ì²˜ë¦¬ (ì›í•˜ë©´ í™œì„±í™”)
